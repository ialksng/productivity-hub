<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Productivity Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .dark .ql-snow .ql-stroke { stroke: #d1d5db; } .dark .ql-snow .ql-fill { fill: #d1d5db; } .dark .ql-snow .ql-picker-label { color: #d1d5db; } .dark .ql-toolbar { border-color: #374151 !important; } .dark .ql-container { border-color: #374151 !important; } .dark .ql-editor { color: #f9fafb; } .dark .ql-editor.ql-blank::before { color: rgba(209, 213, 219, 0.5); } .note-editor-container { height: calc(100vh - 120px); } ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 antialiased">
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://unpkg.com/react-quill@2.0.0/dist/react-quill.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const ReactQuill = window.ReactQuill;

        // --- Icon Components ---
        const CheckSquareIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4" /><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" /></svg>);
        const FileTextIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></svg>);
        const LogOutIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></svg>);
        const PlusIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>);
        const TrashIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>);
        const SunIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>);
        const MoonIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>);
        const MatrixIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="12" x2="21" y2="12"></line><line x1="12" y1="3" x2="12" y2="21"></line></svg>);
        const StarIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>);
        const ZapIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>);
        const CalendarIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>);
        const ChevronLeftIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>);
        const ChevronRightIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>);
        const ShieldIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>);
        const GoogleIcon = () => (<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" className="w-5 h-5"><title>Google</title><path d="M12.48 10.92v3.28h7.84c-.24 1.84-.85 3.18-1.73 4.1-1.02 1.02-2.3 1.62-3.85 1.62-4.64 0-8.54-3.82-8.54-8.42s3.9-8.42 8.54-8.42c2.48 0 4.3.94 5.6 2.24l2.6-2.58C18.04 1.32 15.48 0 12.48 0 5.88 0 .04 5.8 .04 12.5s5.84 12.5 12.44 12.5c3.22 0 5.54-1.14 7.34-2.93 1.94-1.94 2.58-4.9 2.58-7.78 0-.64-.04-1.28-.12-1.88H12.48z" fill="currentColor"/></svg>);
        const GithubIcon = () => (<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" className="w-5 h-5"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" fill="currentColor"/></svg>);
        const ArrowLeftIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>);

        // --- Theme Management ---
        function ThemeSwitcher({ theme, setTheme }) {
            const toggleTheme = () => setTheme(theme === 'light' ? 'dark' : 'light');
            const Icon = theme === 'light' ? MoonIcon : SunIcon;
            return <button onClick={toggleTheme} className="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"><Icon className="w-5 h-5" /></button>;
        }

        // --- Auth Page Component ---
        function AuthPage({ setAuthData, role, onBack }) {
            const [isLogin, setIsLogin] = useState(true);
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const API_BASE_URL = 'http://localhost:5000';

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');
                const url = `${API_BASE_URL}/api/auth/${isLogin ? 'login' : 'register'}`;
                const payload = isLogin ? { email, password } : { name, email, password };
                
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Something went wrong.');
                    
                    if (role === 'admin' && data.user.role !== 'admin') {
                        throw new Error('You are not authorized to access the admin panel.');
                    }
                    setAuthData(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleOAuth = (provider) => {
                window.location.href = `${API_BASE_URL}/api/auth/${provider}`;
            };

            return (
                 <div className="flex items-center justify-center min-h-screen">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg relative">
                        <button onClick={onBack} className="absolute top-4 left-4 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                            <ArrowLeftIcon className="w-6 h-6" />
                        </button>
                        <div className="text-center pt-8">
                            <h1 className="text-3xl font-bold text-gray-900 dark:text-white capitalize">{role} {isLogin ? 'Login' : 'Registration'}</h1>
                            <p className="mt-2 text-gray-600 dark:text-gray-400">Welcome to the hub!</p>
                        </div>
                        {error && <p className="text-center text-red-500 bg-red-100 dark:bg-red-900/20 p-2 rounded-md">{error}</p>}
                        
                        {role === 'student' && (
                            <>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => handleOAuth('google')} className="flex items-center justify-center gap-2 w-full py-2.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"><GoogleIcon /> Google</button>
                                    <button onClick={() => handleOAuth('github')} className="flex items-center justify-center gap-2 w-full py-2.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"><GithubIcon /> GitHub</button>
                                </div>
                                <div className="relative flex py-2 items-center"><div className="flex-grow border-t border-gray-300 dark:border-gray-600"></div><span className="flex-shrink mx-4 text-gray-400">OR</span><div className="flex-grow border-t border-gray-300 dark:border-gray-600"></div></div>
                            </>
                        )}

                        <form className="space-y-6" onSubmit={handleSubmit}>
                            {!isLogin && (
                                <div>
                                    <label htmlFor="name" className="text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                                    <input id="name" type="text" required value={name} onChange={(e) => setName(e.target.value)} className="w-full px-3 py-2 mt-1 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600" placeholder="Your Name" />
                                </div>
                            )}
                            <div>
                                <label htmlFor="email" className="text-sm font-medium text-gray-700 dark:text-gray-300">Email address</label>
                                <input id="email" type="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-3 py-2 mt-1 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600" placeholder="you@example.com" />
                            </div>
                            <div>
                                <label htmlFor="password" className="text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                                <input id="password" type="password" required value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-3 py-2 mt-1 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600" placeholder="••••••••" />
                            </div>
                            <div>
                                <button type="submit" disabled={isLoading} className="w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400">
                                    {isLoading ? 'Processing...' : (isLogin ? 'Sign In' : 'Register')}
                                </button>
                            </div>
                        </form>
                        {role === 'student' && (
                            <p className="text-center text-sm text-gray-600 dark:text-gray-400">
                                {isLogin ? "Don't have an account?" : "Already have an account?"}
                                <button onClick={() => setIsLogin(!isLogin)} className="font-medium text-blue-600 hover:text-blue-500 ml-1">
                                    {isLogin ? 'Register' : 'Sign In'}
                                </button>
                            </p>
                        )}
                    </div>
                </div>
            );
        }

        function RoleSelectionPage({ setRole }) {
            return (
                <div className="flex items-center justify-center min-h-screen">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg text-center">
                        <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Choose Your Role</h1>
                        <p className="text-gray-600 dark:text-gray-400">How would you like to access the hub?</p>
                        <div className="flex flex-col space-y-4 pt-4">
                            <button onClick={() => setRole('student')} className="w-full py-3 px-4 text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg">Student Login / Register</button>
                            <button onClick={() => setRole('admin')} className="w-full py-3 px-4 text-lg font-medium text-white bg-gray-600 hover:bg-gray-700 rounded-lg">Admin Login</button>
                            <button disabled className="w-full py-3 px-4 text-lg font-medium text-gray-400 bg-gray-200 dark:bg-gray-700 rounded-lg cursor-not-allowed">Mentor Login (Coming Soon)</button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function TodoSection({ user }) {
            const [todos, setTodos] = useState([]);
            const [newTodo, setNewTodo] = useState('');
            const [isImportant, setIsImportant] = useState(false);
            const [isUrgent, setIsUrgent] = useState(false);
            const [dueDate, setDueDate] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const API_URL = '/api/todos';

            useEffect(() => {
                const fetchTodos = async () => {
                    try {
                        const response = await fetch(API_URL);
                        if (!response.ok) throw new Error(`Status: ${response.status}`);
                        const data = await response.json();
                        setTodos(data.map(d => ({ ...d, id: d._id })));
                    } catch (err) { setError(err.message); } 
                    finally { setIsLoading(false); }
                };
                fetchTodos();
            }, []);

            const addTodo = async (e) => {
                e.preventDefault();
                if (newTodo.trim() === '') return;
                try {
                    const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: newTodo, isImportant, isUrgent, dueDate: dueDate || null }) });
                    if (!response.ok) throw new Error('Failed to add todo.');
                    const savedTodo = await response.json();
                    setTodos([ { ...savedTodo, id: savedTodo._id }, ...todos]);
                    setNewTodo(''); setIsImportant(false); setIsUrgent(false); setDueDate('');
                } catch (err) { setError(err.message); }
            };

            const updateTodo = async (id, updatedFields) => {
                const originalTodos = [...todos];
                setTodos(todos.map(todo => todo.id === id ? { ...todo, ...updatedFields } : todo));
                try {
                    const response = await fetch(`${API_URL}/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedFields) });
                    if (!response.ok) {
                        setTodos(originalTodos);
                        throw new Error('Failed to update todo.');
                    }
                } catch (err) { setTodos(originalTodos); setError(err.message); }
            };

            const deleteTodo = async (id) => {
                try {
                    const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Failed to delete todo.');
                    setTodos(todos.filter(todo => todo.id !== id));
                } catch (err) { setError(err.message); }
            };

            if (isLoading) return <div className="p-8 text-center text-gray-500 dark:text-gray-400">Loading tasks...</div>;
            if (error) return <div className="p-8 text-center text-red-500 bg-red-100 dark:bg-red-900/20 rounded-lg m-4">{error}</div>;

            const pendingTodos = todos.filter(t => !t.completed).length;
            return (
                <div className="p-4 sm:p-6 lg:p-8 max-w-4xl mx-auto">
                    <h1 className="text-3xl font-bold text-gray-800 dark:text-white">Task List</h1>
                    <p className="mt-1 text-gray-600 dark:text-gray-400">You have {pendingTodos} pending tasks. Let's get it done!</p>
                    <form onSubmit={addTodo} className="mt-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                        <input type="text" value={newTodo} onChange={(e) => setNewTodo(e.target.value)} placeholder="Add a new task..." className="w-full px-2 py-2 text-lg bg-transparent focus:outline-none text-gray-900 dark:text-white" />
                        <div className="mt-3 flex justify-between items-center flex-wrap gap-2">
                            <div className="flex gap-4 items-center flex-wrap">
                                <button type="button" onClick={() => setIsImportant(!isImportant)} className={`flex items-center gap-2 px-3 py-1 rounded-full text-sm ${isImportant ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-300' : 'text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700'}`}><StarIcon className={`w-4 h-4 ${isImportant ? 'fill-current' : ''}`} /> Important</button>
                                <button type="button" onClick={() => setIsUrgent(!isUrgent)} className={`flex items-center gap-2 px-3 py-1 rounded-full text-sm ${isUrgent ? 'bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300' : 'text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700'}`}><ZapIcon className={`w-4 h-4 ${isUrgent ? 'fill-current' : ''}`} /> Urgent</button>
                                <input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className="px-3 py-1 rounded-full text-sm bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <button type="submit" className="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Add Task</button>
                        </div>
                    </form>
                    <div className="mt-6 space-y-3">
                        {todos.map(todo => (
                            <div key={todo.id} className="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm transition-all">
                                <input type="checkbox" checked={todo.completed} onChange={() => updateTodo(todo.id, { completed: !todo.completed })} className="h-5 w-5 rounded-full border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" />
                                <span className={`ml-4 flex-grow text-gray-700 dark:text-gray-300 ${todo.completed ? 'line-through text-gray-400 dark:text-gray-500' : ''}`}>{todo.text}</span>
                                {todo.dueDate && <span className="text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded-full mr-2">{new Date(todo.dueDate).toLocaleDateString()}</span>}
                                <button onClick={() => updateTodo(todo.id, { isImportant: !todo.isImportant })} className={`p-1 rounded-full ${todo.isImportant ? 'text-yellow-400' : 'text-gray-400 hover:text-yellow-400'}`}><StarIcon className={`w-5 h-5 ${todo.isImportant ? 'fill-current' : ''}`} /></button>
                                <button onClick={() => updateTodo(todo.id, { isUrgent: !todo.isUrgent })} className={`p-1 rounded-full ${todo.isUrgent ? 'text-red-500' : 'text-gray-400 hover:text-red-500'}`}><ZapIcon className={`w-5 h-5 ${todo.isUrgent ? 'fill-current' : ''}`} /></button>
                                <button onClick={() => deleteTodo(todo.id)} className="ml-2 p-1 text-gray-400 hover:text-red-500"><TrashIcon className="w-5 h-5" /></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        function EisenhowerMatrix({ user }) {
            const [todos, setTodos] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const API_URL = '/api/todos';

            useEffect(() => {
                const fetchTodos = async () => {
                    try {
                        const response = await fetch(API_URL);
                        if (!response.ok) throw new Error(`Status: ${response.status}`);
                        const data = await response.json();
                        setTodos(data.filter(t => !t.completed).map(d => ({ ...d, id: d._id })));
                    } catch (err) { setError(err.message); } 
                    finally { setIsLoading(false); }
                };
                fetchTodos();
            }, []);

            const categorizedTodos = useMemo(() => ({
                do: todos.filter(t => t.isUrgent && t.isImportant),
                schedule: todos.filter(t => !t.isUrgent && t.isImportant),
                delegate: todos.filter(t => t.isUrgent && !t.isImportant),
                delete: todos.filter(t => !t.isUrgent && !t.isImportant),
            }), [todos]);

            const Quadrant = ({ title, description, tasks, bgColor }) => (
                <div className={`rounded-xl shadow-md p-4 flex flex-col ${bgColor}`}>
                    <h3 className="font-bold text-lg text-gray-800 dark:text-white">{title}</h3>
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">{description}</p>
                    <div className="space-y-2 overflow-y-auto flex-1">
                        {tasks.map(task => (<div key={task.id} className="p-2 bg-white/80 dark:bg-gray-800/80 rounded-md text-sm text-gray-800 dark:text-gray-200">{task.text}</div>))}
                    </div>
                </div>
            );

            if (isLoading) return <div className="p-8 text-center text-gray-500 dark:text-gray-400">Loading matrix...</div>;
            if (error) return <div className="p-8 text-center text-red-500 bg-red-100 dark:bg-red-900/20 rounded-lg m-4">{error}</div>;

            return (
                <div className="p-4 sm:p-6 lg:p-8 h-full flex flex-col">
                    <h1 className="text-3xl font-bold text-gray-800 dark:text-white">Eisenhower Matrix</h1>
                    <p className="mt-1 text-gray-600 dark:text-gray-400">Prioritize your tasks to focus on what truly matters.</p>
                    <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6 flex-1">
                        <Quadrant title="Do" description="Urgent & Important" tasks={categorizedTodos.do} bgColor="bg-green-100 dark:bg-green-500/10" />
                        <Quadrant title="Schedule" description="Not Urgent & Important" tasks={categorizedTodos.schedule} bgColor="bg-blue-100 dark:bg-blue-500/10" />
                        <Quadrant title="Delegate" description="Urgent & Not Important" tasks={categorizedTodos.delegate} bgColor="bg-orange-100 dark:bg-orange-500/10" />
                        <Quadrant title="Delete" description="Not Urgent & Not Important" tasks={categorizedTodos.delete} bgColor="bg-red-100 dark:bg-red-500/10" />
                    </div>
                </div>
            );
        }
        function ScheduleSection({ user }) {
            const [todos, setTodos] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date());
            const API_URL = '/api/todos';

            useEffect(() => {
                const fetchTodos = async () => {
                    try {
                        const response = await fetch(API_URL);
                        if (!response.ok) throw new Error(`Status: ${response.status}`);
                        const data = await response.json();
                        setTodos(data.map(d => ({ ...d, id: d._id })));
                    } catch (err) { setError(err.message); } 
                    finally { setIsLoading(false); }
                };
                fetchTodos();
            }, []);

            const changeMonth = (offset) => setCurrentDate(d => { const n = new Date(d); n.setMonth(n.getMonth() + offset); return n; });

            const calendarGrid = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let days = [];
                for (let i = 0; i < firstDayOfMonth; i++) days.push({ key: `e-${i}` });
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayTasks = todos.filter(t => t.dueDate && new Date(t.dueDate).toDateString() === date.toDateString());
                    days.push({ key: day, day, date, tasks: dayTasks });
                }
                return days;
            }, [currentDate, todos]);

            if (isLoading) return <div className="p-8 text-center text-gray-500 dark:text-gray-400">Loading schedule...</div>;
            if (error) return <div className="p-8 text-center text-red-500 bg-red-100 dark:bg-red-900/20 rounded-lg m-4">{error}</div>;

            return (
                <div className="p-4 sm:p-6 lg:p-8 h-full flex flex-col">
                    <div className="flex justify-between items-center">
                        <h1 className="text-3xl font-bold text-gray-800 dark:text-white">Schedule Planner</h1>
                        <div className="flex items-center gap-4">
                            <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><ChevronLeftIcon className="w-6 h-6 text-gray-600 dark:text-gray-300" /></button>
                            <h2 className="text-xl font-semibold text-gray-700 dark:text-gray-200">{currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                            <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><ChevronRightIcon className="w-6 h-6 text-gray-600 dark:text-gray-300" /></button>
                        </div>
                    </div>
                    <div className="mt-6 grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700 flex-1 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (<div key={day} className="text-center font-semibold text-sm py-2 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300">{day}</div>))}
                        {calendarGrid.map(({ key, day, date, tasks }) => (
                            <div key={key} className="p-2 bg-white dark:bg-gray-800 min-h-[120px] flex flex-col">
                                {day && <span className={`font-medium ${new Date().toDateString() === date?.toDateString() ? 'bg-blue-600 text-white rounded-full w-7 h-7 flex items-center justify-center' : 'text-gray-700 dark:text-gray-300'}`}>{day}</span>}
                                <div className="mt-1 space-y-1 overflow-y-auto">
                                    {tasks?.map(task => (<div key={task.id} className={`p-1.5 text-xs rounded-md ${task.isImportant ? 'bg-yellow-100 dark:bg-yellow-500/20 text-yellow-800 dark:text-yellow-300' : 'bg-blue-100 dark:bg-blue-500/20 text-blue-800 dark:text-blue-300'}`}>{task.text}</div>))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        function NotesSection({ user }) {
            const [notes, setNotes] = useState([]);
            const [activeNote, setActiveNote] = useState(null);
            const [currentContent, setCurrentContent] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const API_URL = '/api/notes';
            if (!ReactQuill) return <div className="p-8 text-center text-gray-500 dark:text-gray-400">Loading Editor...</div>;

            const quillModules = { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike', 'blockquote', 'code-block'], [{'list': 'ordered'}, {'list': 'bullet'}], ['link'], ['clean']] };

            useEffect(() => {
                const fetchNotes = async () => {
                    try {
                        const response = await fetch(API_URL);
                        if (!response.ok) throw new Error(`Status: ${response.status}`);
                        const data = await response.json();
                        setNotes(data.map(n => ({...n, id: n._id})));
                    } catch (err) { setError(err.message); } 
                    finally { setIsLoading(false); }
                };
                fetchNotes();
            }, []);

            useEffect(() => {
                if (activeNote) setCurrentContent(activeNote.content);
                else setCurrentContent('');
            }, [activeNote]);

            useEffect(() => {
                if (!activeNote || currentContent === activeNote.content) return;
                const handler = setTimeout(() => updateNote(activeNote.id, { content: currentContent }), 1500);
                return () => clearTimeout(handler);
            }, [currentContent, activeNote]);

            const createNewNote = async () => {
                const title = prompt("Enter a title for your new note:");
                if (!title || title.trim() === '') return;
                try {
                    const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title }) });
                    if (!response.ok) throw new Error('Failed to create note.');
                    const newNote = await response.json();
                    const formattedNote = { ...newNote, id: newNote._id };
                    setNotes([formattedNote, ...notes]);
                    setActiveNote(formattedNote);
                } catch (err) { setError(err.message); }
            };

            const updateNote = async (id, updatedFields) => {
                try {
                    const response = await fetch(`${API_URL}/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedFields) });
                    if (!response.ok) throw new Error('Failed to update note.');
                    const updatedNote = await response.json();
                    const formattedNote = { ...updatedNote, id: updatedNote._id };
                    setNotes(notes.map(n => n.id === id ? formattedNote : n));
                } catch (err) { setError(err.message); }
            };

            const deleteNote = async (id) => {
                if (!window.confirm("Are you sure?")) return;
                try {
                    const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Failed to delete note.');
                    setNotes(notes.filter(n => n.id !== id));
                    if (activeNote && activeNote.id === id) setActiveNote(null);
                } catch (err) { setError(err.message); }
            };

            if (isLoading) return <div className="p-8 text-center text-gray-500 dark:text-gray-400">Loading notes...</div>;
            if (error) return <div className="p-8 text-center text-red-500 bg-red-100 dark:bg-red-900/20 rounded-lg m-4">{error}</div>;

            return (
                <div className="flex h-full">
                    <div className="w-1/3 max-w-xs h-full flex flex-col bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
                        <div className="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-gray-800 dark:text-white">My Notes</h2>
                            <button onClick={createNewNote} className="p-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Create New Note"><PlusIcon className="w-5 h-5" /></button>
                        </div>
                        <div className="overflow-y-auto">
                            {notes.map(note => (<div key={note.id} onClick={() => setActiveNote(note)} className={`p-4 cursor-pointer border-b border-gray-200 dark:border-gray-700 ${activeNote?.id === note.id ? 'bg-blue-100 dark:bg-blue-900/50' : 'hover:bg-gray-100 dark:hover:bg-gray-700/50'}`}><h3 className="font-semibold text-gray-800 dark:text-white truncate">{note.title}</h3><p className="text-sm text-gray-500 dark:text-gray-400">Modified: {new Date(note.lastModified).toLocaleDateString()}</p></div>))}
                        </div>
                    </div>
                    <div className="flex-1 flex flex-col">
                        {activeNote ? (
                            <>
                                <div className="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800">
                                    <h2 className="text-xl font-bold text-gray-800 dark:text-white">{activeNote.title}</h2>
                                    <button onClick={() => deleteNote(activeNote.id)} className="p-2 text-gray-500 rounded-lg hover:bg-red-100 hover:text-red-600 dark:hover:bg-red-900/50 dark:hover:text-red-400" title="Delete Note"><TrashIcon className="w-5 h-5" /></button>
                                </div>
                                <div className="flex-1 bg-white dark:bg-gray-900 note-editor-container">
                                     <ReactQuill value={currentContent} onChange={setCurrentContent} modules={quillModules} theme="snow" className="h-full w-full" />
                                </div>
                            </>
                        ) : (<div className="flex items-center justify-center h-full text-gray-500 dark:text-gray-400"><div className="text-center"><FileTextIcon className="mx-auto h-16 w-16" /><p className="mt-4 text-lg">Select a note to view or create a new one.</p></div></div>)}
                    </div>
                </div>
            );
        }
        
        function Dashboard({ authData, onLogout, theme, setTheme }) {
          const [activeView, setActiveView] = useState('todo');
          const { user } = authData;
          
          const NavLink = ({ view, icon: Icon, children }) => (<button onClick={() => setActiveView(view)} className={`flex items-center w-full px-3 py-2.5 text-sm font-medium rounded-lg transition-colors ${activeView === view ? 'bg-blue-600 text-white' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'}`}><Icon className="w-5 h-5" /><span className="ml-3">{children}</span></button>);

          return (
            <div className="flex h-screen">
              <aside className="w-60 flex-shrink-0 bg-white dark:bg-gray-800 flex flex-col border-r border-gray-200 dark:border-gray-700">
                <div className="h-16 flex items-center px-4"><h1 className="text-xl font-bold text-gray-900 dark:text-white">Productivity Hub</h1></div>
                <nav className="flex-1 px-4 py-4 space-y-2">
                    <NavLink view="todo" icon={CheckSquareIcon}>Task List</NavLink>
                    <NavLink view="matrix" icon={MatrixIcon}>Eisenhower Matrix</NavLink>
                    <NavLink view="schedule" icon={CalendarIcon}>Schedule</NavLink>
                    <NavLink view="notes" icon={FileTextIcon}>Note Making</NavLink>
                    {user.role === 'admin' && <NavLink view="admin" icon={ShieldIcon}>Admin Panel</NavLink>}
                </nav>
                <div className="px-4 py-4 border-t border-gray-200 dark:border-gray-700">
                    <div className="flex items-center justify-between">
                        <div className="text-sm"><p className="font-semibold text-gray-800 dark:text-white">{user.name}</p><p className="text-gray-500 dark:text-gray-400">{user.email}</p></div>
                        <ThemeSwitcher theme={theme} setTheme={setTheme} />
                    </div>
                    <button onClick={onLogout} className="w-full mt-4 flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg"><LogOutIcon className="w-5 h-5" /><span>Logout</span></button>
                </div>
              </aside>
              <main className="flex-1 overflow-y-auto">
                {activeView === 'todo' && <TodoSection user={user} />}
                {activeView === 'matrix' && <EisenhowerMatrix user={user} />}
                {activeView === 'schedule' && <ScheduleSection user={user} />}
                {activeView === 'notes' && <NotesSection user={user} />}
                {activeView === 'admin' && user.role === 'admin' && <div className="p-8"><h1 className="text-3xl font-bold text-gray-800 dark:text-white">Admin Panel</h1><p className="mt-2 text-gray-600 dark:text-gray-400">Welcome, Admin! This area is for managing users and content.</p></div>}
              </main>
            </div>
          );
        }

        function App() {
            const [authData, setAuthData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [role, setRole] = useState(null);
            const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'dark');

            useEffect(() => {
                const checkLoggedIn = async () => {
                    try {
                        const response = await fetch('/api/auth/me');
                        if (response.ok) {
                            const data = await response.json();
                            setAuthData(data);
                        } else {
                           // This handles the case where the cookie is invalid or expired
                           localStorage.removeItem('authData'); // Clean up old data if any
                        }
                    } catch (err) {
                        console.error("Auth check failed, likely server is not running.", err);
                    } finally {
                        setIsLoading(false);
                    }
                };
                checkLoggedIn();
            }, []);

            useEffect(() => {
                const root = window.document.documentElement;
                if (theme === 'dark') root.classList.add('dark');
                else root.classList.remove('dark');
                localStorage.setItem('theme', theme);
            }, [theme]);
            
            const handleLogout = async () => {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                } catch (err) {
                    console.error("Logout failed", err);
                } finally {
                    setAuthData(null);
                    setRole(null);
                }
            };

            if (isLoading) {
                return <div className="flex items-center justify-center min-h-screen text-gray-500">Loading...</div>;
            }

            if (!authData) {
                if (!role) return <RoleSelectionPage setRole={setRole} />;
                return <AuthPage setAuthData={setAuthData} role={role} onBack={() => setRole(null)} />;
            }
            
            return <Dashboard authData={authData} onLogout={handleLogout} theme={theme} setTheme={setTheme} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>